<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Mini Angry Birds - ESP32</title>
<style>
  body {
    margin: 0;
    overflow: hidden;
    background: #87ceeb;
    font-family: Arial;
  }
  #info {
    position: absolute;
    top: 10px;
    left: 10px;
    background: #ffffffcc;
    padding: 10px 15px;
    border-radius: 10px;
    font-size: 16px;
  }
  canvas {
    display: block;
  }
</style>
</head>
<body>

<div id="info">
  <b>Angry Birds - ESP32</b><br>
  Ângulo: <span id="ang">0</span>°<br>
  Força: <span id="force">0</span><br>
  Botão: <span id="btn">0</span><br>
</div>

<canvas id="game"></canvas>

<script>
// =========================
// CANVAS
// =========================
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// =========================
// WEBSOCKET
// =========================
const ws = new WebSocket("ws://10.68.55.64/ws");

let angle = 45;   // joystick Y
let force = 0;    // ultrassom 0..1
let fire  = 0;    // botão

ws.onmessage = (msg) => {
    const data = JSON.parse(msg.data);

    angle = Math.max(0, Math.min(90, data.a));
    force = data.f;
    fire  = data.b;

    document.getElementById("ang").textContent = angle.toFixed(1);
    document.getElementById("force").textContent = (force * 100).toFixed(0);
    document.getElementById("btn").textContent = fire;

    if (fire === 1) shoot();
};

// =========================
// PÁSSARO
// =========================
let birdStartX = 200;
let birdStartY = canvas.height - 150;

let bird = {
  x: birdStartX,
  y: birdStartY,
  vx: 0,
  vy: 0,
  active: false,
};

const gravity = 0.45;

// =========================
// OBSTÁCULOS
// =========================
const obstacles = [
  { x: 800, y: canvas.height - 160, w: 60, h: 80, color: "#8b5a2b" },
  { x: 900, y: canvas.height - 160, w: 60, h: 120, color: "#b5651d" },
  { x: 1000, y: canvas.height - 160, w: 60, h: 60, color: "#7d4b2b" }
];

// =========================
// DESENHO DO CENÁRIO
// =========================
function drawBackground() {
    ctx.fillStyle = "#87ceeb";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.fillStyle = "#55aa33";
    ctx.fillRect(0, canvas.height - 80, canvas.width, 80);
}

function drawObstacles() {
    obstacles.forEach(o => {
        ctx.fillStyle = o.color;
        ctx.fillRect(o.x, o.y - o.h, o.w, o.h);
    });
}

function drawSlingshot() {
    const len = force * 80;

    ctx.beginPath();
    ctx.lineWidth = 6;
    ctx.strokeStyle = "#553311";
    ctx.moveTo(birdStartX, birdStartY);
    ctx.lineTo(
        birdStartX + Math.cos(-angle * Math.PI/180) * len,
        birdStartY + Math.sin(-angle * Math.PI/180) * len
    );
    ctx.stroke();
}

// =========================
// MIRA (SETA)
// =========================
function drawAimArrow() {
    if (bird.active) return;

    const baseX = birdStartX;
    const baseY = birdStartY;

    const len = 120 + force * 80;
    const rad = -angle * Math.PI / 180;

    const endX = baseX + Math.cos(rad) * len;
    const endY = baseY + Math.sin(rad) * len;

    ctx.strokeStyle = "rgba(255,0,0,0.8)";
    ctx.lineWidth = 4;

    ctx.beginPath();
    ctx.moveTo(baseX, baseY);
    ctx.lineTo(endX, endY);
    ctx.stroke();

    // ponta da seta
    ctx.beginPath();
    ctx.moveTo(endX, endY);
    ctx.lineTo(endX - Math.cos(rad + 0.4) * 20, endY - Math.sin(rad + 0.4) * 20);
    ctx.lineTo(endX - Math.cos(rad - 0.4) * 20, endY - Math.sin(rad - 0.4) * 20);
    ctx.lineTo(endX, endY);
    ctx.fillStyle = "rgba(255,0,0,0.8)";
    ctx.fill();
}

// =========================
// DESENHAR PÁSSARO
// =========================
function drawBird() {
    ctx.beginPath();
    ctx.fillStyle = "red";
    ctx.arc(bird.x, bird.y, 20, 0, Math.PI * 2);
    ctx.fill();
}

// =========================
// COLISÃO COM OBSTÁCULOS
// =========================
function checkCollision() {
    for (const o of obstacles) {
        if (
            bird.x + 20 > o.x &&
            bird.x - 20 < o.x + o.w &&
            bird.y + 20 > o.y - o.h &&
            bird.y - 20 < o.y
        ) {
            resetBird();
            return;
        }
    }
}

// =========================
// FÍSICA DO PÁSSARO
// =========================
function updateBird() {
    if (!bird.active) return;

    bird.vy += gravity;
    bird.x += bird.vx;
    bird.y += bird.vy;

    checkCollision();

    // chão
    if (bird.y > canvas.height - 80) {
        resetBird();
    }
}

// =========================
// RESETAR PÁSSARO
// =========================
function resetBird() {
    bird.x = birdStartX;
    bird.y = birdStartY;
    bird.vx = 0;
    bird.vy = 0;
    bird.active = false;
}

// =========================
// DISPARO
// =========================
function shoot() {
    if (bird.active) return;

    const rad = angle * Math.PI / 180;
    const power = force * 25;

    bird.vx = Math.cos(rad) * power;
    bird.vy = -Math.sin(rad) * power;
    bird.active = true;
}

// =========================
// LOOP DO JOGO
// =========================
function gameLoop() {
    drawBackground();
    drawObstacles();
    drawSlingshot();
    drawAimArrow();
    drawBird();
    updateBird();

    requestAnimationFrame(gameLoop);
}

gameLoop();

</script>
</body>
</html>
