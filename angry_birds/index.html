<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<title>Mini Angry Birds - ESP32</title>
<style>
  body {
    margin: 0;
    overflow: hidden;
    background: #87ceeb;
    font-family: Arial;
  }
  #info {
    position: absolute;
    top: 10px;
    left: 10px;
    background: #ffffffcc;
    padding: 10px 15px;
    border-radius: 10px;
    font-size: 16px;
  }
  #scorePanel {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #fffa;
    padding: 15px 20px;
    border-radius: 10px;
    font-size: 24px;
    font-weight: bold;
    color: #d32f2f;
  }
  #message {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 48px;
    font-weight: bold;
    color: #ff0000;
    text-shadow: 2px 2px #000;
    display: none;
  }
  canvas { display: block; }
</style>
</head>
<body>

<div id="info">
  Ângulo: <span id="ang">0</span>°<br />
  Força: <span id="force">0</span><br />
  Botão: <span id="btn">0</span><br />
  Jogadas: <span id="shots">0</span>/10
</div>
<div id="scorePanel">Score: <span id="score">0</span></div>
<div id="message"></div>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// FÍSICA
const gravity = 0.45;
const airResistance = 0.995;

let angle = 45;
let force = 0;
let fire = 0;

// WEBSOCKET
const ws = new WebSocket("ws://10.68.55.64/ws");
ws.onmessage = (msg) => {
  const data = JSON.parse(msg.data);
  angle = data.a;
  force = data.f;
  fire = data.b;

  document.getElementById("ang").textContent = angle.toFixed(1);
  document.getElementById("force").textContent = (force * 100).toFixed(0);
  document.getElementById("btn").textContent = fire;

  if (fire === 1) shoot();
};

// SPRITES
const birdImg = new Image();
birdImg.src = "bird.png";
const pigImg = new Image();
pigImg.src = "pig.png";
const boxImg = new Image();
boxImg.src = "box.png";

// PÁSSARO
let birdStartX = 150;
let birdStartY = canvas.height - 100;
let bird = { 
  x: birdStartX, 
  y: birdStartY, 
  vx: 0, 
  vy: 0, 
  active: false,
  bounces: 0,
  maxBounces: 3
};

// PONTUAÇÃO E JOGADAS
let score = 0;
let shots = 0;
const maxShots = 10;

// CHÃO
const groundY = canvas.height - 80;

// OBSTÁCULOS
let obstacles = [
  { x: 500, y: groundY, w: 40, h: 40, type: "destrutível" }, 
  { x: 810, y: groundY, w: 60, h: 60, type: "destrutível" }, 
  { x: 200, y: groundY - 300, w: 50, h: 50, type: "destrutível" },
  { x: 800, y: groundY - 500, w: 80, h: 80, type: "destrutível" }, 
  { x: 1310, y: groundY, w: 100, h: 70, type: "destrutível" },
  { x: 1500, y: groundY, w: 80, h: 100, type: "destrutível" },
  { x: 1500, y: groundY - 100, w: 80, h: 100, type: "destrutível" },
  { x: 980, y: groundY - 500, w: 20, h: 400, type: "inútil" },
  { x: 980, y: groundY, w: 20, h: 200, type: "inútil" }
];

// PORCOS
let pigs = [
  { x: 500 + 10, y: groundY - 40 - 20, w: 40, h: 40, active: true, vy:0 },
  { x: 810 + 0, y: groundY - 60 - 20, w: 40, h: 40, active: true, vy:0 },
  { x: 800 + 20, y: groundY - 580 - 20, w: 40, h: 40, active: true, vy:0 },
  { x: 1530, y: groundY - 200 - 20, w: 40, h: 40, active: true, vy:0 },
];

// PARTICULAS
let particles = [];
function createExplosion(x, y, color = "orange") {
  for (let i = 0; i < 15; i++) {
    particles.push({
      x,
      y,
      vx: (Math.random() - 0.5) * 6,
      vy: (Math.random() - 0.5) * 6,
      radius: Math.random() * 5 + 2,
      life: 30,
      color,
    });
  }
}
function updateParticles() {
  for (let i = particles.length - 1; i >= 0; i--) {
    const p = particles[i];
    p.x += p.vx;
    p.y += p.vy;
    p.vy += 0.2;
    p.life--;
    if (p.life <= 0) particles.splice(i, 1);
  }
}
function drawParticles() {
  particles.forEach((p) => {
    ctx.beginPath();
    ctx.fillStyle = p.color;
    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
    ctx.fill();
  });
}

// DESENHO
function drawBackground() {
  ctx.fillStyle = "#87ceeb";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  ctx.fillStyle = "#55aa33";
  ctx.fillRect(0, groundY, canvas.width, 80);
}
function drawObstacles() {
  obstacles.forEach((o) => {
    if (o.type === "destrutível") {
      ctx.drawImage(boxImg, o.x, o.y - o.h, o.w, o.h);
    } else {
      ctx.fillStyle = "#888888";
      ctx.fillRect(o.x, o.y - o.h, o.w, o.h);
    }
  });
}
function drawPigs() {
  pigs.forEach(p => {
    if (p.active) {
      ctx.drawImage(pigImg, p.x - p.w/2, p.y - p.h/2, p.w, p.h);
    }
  });
}
function drawAimArrow() {
  if (bird.active) return;

  const baseX = birdStartX;
  const baseY = birdStartY;
  const len = 120 + force * 80;
  const rad = (-angle * Math.PI) / 180;
  const endX = baseX + Math.cos(rad) * len;
  const endY = baseY + Math.sin(rad) * len;

  ctx.strokeStyle = "rgba(220,220,220,0.8)";
  ctx.lineWidth = 4;
  ctx.beginPath();
  ctx.moveTo(baseX, baseY);
  ctx.lineTo(endX, endY);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(endX, endY);
  ctx.lineTo(endX - Math.cos(rad + 0.4) * 20, endY - Math.sin(rad + 0.4) * 20);
  ctx.lineTo(endX - Math.cos(rad - 0.4) * 20, endY - Math.sin(rad - 0.4) * 20);
  ctx.lineTo(endX, endY);
  ctx.fillStyle = "rgba(50,50,50,0.8)";
  ctx.fill();
}
function drawBird() {
  const size = 40;
  const angleR = Math.atan2(bird.vy, bird.vx);
  ctx.save();
  ctx.translate(bird.x, bird.y);
  ctx.rotate(angleR);
  ctx.drawImage(birdImg, -size/2, -size/2, size, size);
  ctx.restore();
}

// FÍSICA E COLISÃO
function checkCollision() {
  // Obstáculos
  for (let i = obstacles.length - 1; i >= 0; i--) {
    const o = obstacles[i];
    const collidedX = bird.x + 20 > o.x && bird.x - 20 < o.x + o.w;
    const collidedY = bird.y + 20 > o.y - o.h && bird.y - 20 < o.y;

    if (collidedX && collidedY) {
      if (o.type === "destrutível") {
        score += 10;
        document.getElementById("score").textContent = score;
        createExplosion(bird.x, bird.y, "brown");
        obstacles.splice(i, 1);
        resetBird();
        return;
      } else if (o.type === "inútil") {
        const overlapX = Math.min(bird.x + 20 - o.x, o.x + o.w - (bird.x - 20));
        const overlapY = Math.min(bird.y + 20 - (o.y - o.h), o.y - (bird.y - 20));

        if (overlapX < overlapY) bird.vx *= -0.7;
        else bird.vy *= -0.6;
        bird.bounces++;
        return;
      }
    }
  }

  // Porcos
  pigs.forEach(p => {
    if (p.active) {
      const collidedX = bird.x + 20 > p.x - p.w/2 && bird.x - 20 < p.x + p.w/2;
      const collidedY = bird.y + 20 > p.y - p.h/2 && bird.y - 20 < p.y + p.h/2;
      if (collidedX && collidedY) {
        p.active = false;
        score += 20;
        document.getElementById("score").textContent = score;
        createExplosion(p.x, p.y, "green");
      }
    }
  });
}

function updateBird() {
  if (!bird.active) return;

  bird.vx *= airResistance;
  bird.vy *= airResistance;
  bird.vy += gravity;

  bird.x += bird.vx;
  bird.y += bird.vy;

  checkCollision();

  // Rebotes no chão
  if (bird.y > groundY) {
    bird.y = groundY;
    if (bird.bounces < bird.maxBounces) {
      bird.vy *= -0.6;
      bird.vx *= 0.8;
      bird.bounces++;
    } else {
      resetBird();
    }
  }
}

// Atualiza porcos caindo se não estiverem apoiados
function updatePigs() {
  pigs.forEach(p => {
    if (!p.active) return;

    let supported = false;
    // Verifica se apoiado em algum obstáculo
    obstacles.forEach(o => {
      if (o.type === "destrutível" && 
          p.x + p.w/2 > o.x && p.x - p.w/2 < o.x + o.w &&
          Math.abs((p.y + p.h/2) - (o.y - o.h)) < 5) {
        supported = true;
      }
    });

    if (!supported) {
      p.vy += gravity;
      p.y += p.vy;

      // Colisão com o chão
      if (p.y + p.h/2 >= groundY) {
        p.y = groundY - p.h/2;
        p.active = false;
      }
    } else {
      p.vy = 0; // mantém parado sobre o obstáculo
    }
  });
}

function resetBird() {
  bird.x = birdStartX;
  bird.y = birdStartY;
  bird.vx = 0;
  bird.vy = 0;
  bird.active = false;
  bird.bounces = 0;

  shots++;
  document.getElementById("shots").textContent = shots;

  checkEndGame();
}

function shoot() {
  if (bird.active || shots >= maxShots) return;
  const rad = (angle * Math.PI) / 180;
  const power = force * 29;
  bird.vx = Math.cos(rad) * power;
  bird.vy = -Math.sin(rad) * power;
  bird.active = true;
}

function checkEndGame() {
  const destrutiveLeft = obstacles.some(o => o.type === "destrutível");
  if (!destrutiveLeft) showMessage("Você Venceu!");
  else if (shots >= maxShots) showMessage("Você Perdeu!");
}

function showMessage(text) {
  const msgDiv = document.getElementById("message");
  msgDiv.textContent = text;
  msgDiv.style.display = "block";
}

function gameLoop() {
  drawBackground();
  drawObstacles();
  drawPigs();
  drawAimArrow();
  drawBird();
  updateBird();
  updatePigs();
  updateParticles();
  drawParticles();
  requestAnimationFrame(gameLoop);
}

gameLoop();
</script>
</body>
</html>
