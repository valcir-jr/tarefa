<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<title>Mini Angry Birds - ESP32</title>
<style>
  body {
    margin: 0;
    overflow: hidden;
    background: #87ceeb;
    font-family: Arial;
  }
  #info {
    position: absolute;
    top: 10px;
    left: 10px;
    background: #ffffffcc;
    padding: 10px 15px;
    border-radius: 10px;
    font-size: 16px;
  }
  #scorePanel {
    position: absolute;
    top: 10px;
    right: 10px;
    background: #fffa;
    padding: 15px 20px;
    border-radius: 10px;
    font-size: 24px;
    font-weight: bold;
    color: #d32f2f;
  }
  #message {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 48px;
    font-weight: bold;
    color: #ff0000;
    text-shadow: 2px 2px #000;
    display: none;
  }
  canvas { display: block; }
</style>
</head>
<body>

<div id="info">
  Ângulo: <span id="ang">0</span>°<br />
  Força: <span id="force">0</span><br />
  Botão: <span id="btn">0</span><br />
  Jogadas: <span id="shots">0</span>/10
</div>
<div id="scorePanel">Score: <span id="score">0</span></div>
<div id="message"></div>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const gravity = 0.45;

let angle = 45;
let force = 0;
let fire = 0;

const ws = new WebSocket("ws://10.68.55.64/ws");
ws.onmessage = (msg) => {
  const data = JSON.parse(msg.data);
  angle = data.a;
  force = data.f;
  fire = data.b;

  document.getElementById("ang").textContent = angle.toFixed(1);
  document.getElementById("force").textContent = (force * 100).toFixed(0);
  document.getElementById("btn").textContent = fire;

  if (fire === 1) shoot();
};

// PÁSSARO
let birdStartX = 150;
let birdStartY = canvas.height - 100;
let bird = { x: birdStartX, y: birdStartY, vx: 0, vy: 0, active: false };

// PONTUAÇÃO E JOGADAS
let score = 0;
let shots = 0;
const maxShots = 10;

// OBSTÁCULOS - baseado na imagem enviada
// chão: canvas.height - 80 (altura do chão)
const groundY = canvas.height - 80;

let obstacles = [
  // 5 destrutíveis (marrons) - posição e tamanho aproximados da imagem
  { x: 650, y: groundY, w: 40, h: 40, color: "#b07050", type: "destrutível" }, 
  { x: 810, y: groundY, w: 60, h: 60, color: "#a55a36", type: "destrutível" }, 
  { x: 890, y: groundY - 40, w: 50, h: 50, color: "#9e5b39", type: "destrutível" }, 
  { x: 1010, y: groundY, w: 60, h: 60, color: "#b2754a", type: "destrutível" },
  { x: 1100, y: groundY, w: 60, h: 60, color: "#c78d63", type: "destrutível" },

  // 2 inúteis (cinzas verticais)
  { x: 980, y: groundY - 500, w: 20, h: 400, color: "#888888", type: "inútil" },
  { x: 980, y: groundY, w: 20, h: 200, color: "#555555", type: "inútil" }
];

// PARTICULAS
let particles = [];
function createExplosion(x, y, color = "orange") {
  for (let i = 0; i < 15; i++) {
    particles.push({
      x,
      y,
      vx: (Math.random() - 0.5) * 6,
      vy: (Math.random() - 0.5) * 6,
      radius: Math.random() * 5 + 2,
      life: 30,
      color,
    });
  }
}
function updateParticles() {
  for (let i = particles.length - 1; i >= 0; i--) {
    const p = particles[i];
    p.x += p.vx;
    p.y += p.vy;
    p.vy += 0.2;
    p.life--;
    if (p.life <= 0) particles.splice(i, 1);
  }
}
function drawParticles() {
  particles.forEach((p) => {
    ctx.beginPath();
    ctx.fillStyle = p.color;
    ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
    ctx.fill();
  });
}

// DESENHO
function drawBackground() {
  ctx.fillStyle = "#87ceeb";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  ctx.fillStyle = "#55aa33";
  ctx.fillRect(0, groundY, canvas.width, 80);
}
function drawObstacles() {
  obstacles.forEach((o) => {
    ctx.fillStyle = o.color;
    ctx.fillRect(o.x, o.y - o.h, o.w, o.h);
  });
}
function drawAimArrow() {
  if (bird.active) return;

  const baseX = birdStartX;
  const baseY = birdStartY;
  const len = 120 + force * 80;
  const rad = (-angle * Math.PI) / 180;
  const endX = baseX + Math.cos(rad) * len;
  const endY = baseY + Math.sin(rad) * len;

  ctx.strokeStyle = "rgba(220,220,220,0.8)";
  ctx.lineWidth = 4;
  ctx.beginPath();
  ctx.moveTo(baseX, baseY);
  ctx.lineTo(endX, endY);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(endX, endY);
  ctx.lineTo(endX - Math.cos(rad + 0.4) * 20, endY - Math.sin(rad + 0.4) * 20);
  ctx.lineTo(endX - Math.cos(rad - 0.4) * 20, endY - Math.sin(rad - 0.4) * 20);
  ctx.lineTo(endX, endY);
  ctx.fillStyle = "rgba(50,50,50,0.8)";
  ctx.fill();
}
function drawBird() {
  ctx.beginPath();
  ctx.fillStyle = "red";
  ctx.arc(bird.x, bird.y, 20, 0, Math.PI * 2);
  ctx.fill();
}

// FÍSICA E COLISÃO
function checkCollision() {
  for (let i = obstacles.length - 1; i >= 0; i--) {
    const o = obstacles[i];
    if (
      bird.x + 20 > o.x &&
      bird.x - 20 < o.x + o.w &&
      bird.y + 20 > o.y - o.h &&
      bird.y - 20 < o.y
    ) {
      if (o.type === "destrutível") {
        score += 10;
        document.getElementById("score").textContent = score;
        createExplosion(bird.x, bird.y, o.color);
        obstacles.splice(i, 1);
      }
      // inútil: só atrapalha, sem ponto
      resetBird();
      return;
    }
  }
}

function updateBird() {
  if (!bird.active) return;
  bird.vy += gravity;
  bird.x += bird.vx;
  bird.y += bird.vy;

  checkCollision();

  if (bird.y > groundY) {
    resetBird();
  }
}

function resetBird() {
  bird.x = birdStartX;
  bird.y = birdStartY;
  bird.vx = 0;
  bird.vy = 0;
  bird.active = false;

  shots++;
  document.getElementById("shots").textContent = shots;

  checkEndGame();
}

function shoot() {
  if (bird.active || shots >= maxShots) return;
  const rad = (angle * Math.PI) / 180;
  const power = force * 25;
  bird.vx = Math.cos(rad) * power;
  bird.vy = -Math.sin(rad) * power;
  bird.active = true;
}

// VITÓRIA / DERROTA
function checkEndGame() {
  const destrutiveLeft = obstacles.some((o) => o.type === "destrutível");
  if (!destrutiveLeft) showMessage("Você Venceu!");
  else if (shots >= maxShots) showMessage("Você Perdeu!");
}

function showMessage(text) {
  const msgDiv = document.getElementById("message");
  msgDiv.textContent = text;
  msgDiv.style.display = "block";
}

// LOOP
function gameLoop() {
  drawBackground();
  drawObstacles();
  drawAimArrow();
  drawBird();
  updateBird();
  updateParticles();
  drawParticles();
  requestAnimationFrame(gameLoop);
}

gameLoop();
</script>
</body>
</html>
